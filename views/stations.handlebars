<body class="min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-emerald-50 flex items-center justify-center p-5">
    <div class="bg-white rounded-lg shadow-2xl max-w-5xl w-full p-10">
        <a href="/admin" class="inline-block mb-5 px-5 py-2 bg-gray-500 text-white text-sm font-semibold rounded-lg transition-all hover:bg-gray-600 hover:-translate-x-1">‚Üê Back to Home</a>
        
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">{{title}}</h1>
        <p class="text-center text-gray-600 mb-8">Click on a station to manage tickets</p>

        <div id="stationsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mb-8"></div>
        
        <div id="queueInfo" class="text-center mt-8 p-5 bg-gray-100 rounded-lg">
            <strong id="queueRemaining">0</strong> tickets remaining in queue
        </div>
    </div>

    <script>
        let socket;

        // Initialize WebSocket
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(protocol + '//' + window.location.host + '/ws/stations');

            socket.onopen = () => {
                console.log('WebSocket connected');
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'stations') {
                    renderStations(data);
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            socket.onclose = () => {
                console.log('WebSocket disconnected, reconnecting in 3 seconds...');
                setTimeout(initWebSocket, 3000);
            };
        }

        function renderStations(data) {
            if (!data || !data.stations) {
                return;
            }

            const container = document.getElementById('stationsContainer');
            container.innerHTML = '';

            data.stations.forEach(station => {
                const card = document.createElement('a');
                card.href = `/station-view/${station.id}`;
                card.className = 'group bg-gray-50 border-2 border-gray-200 rounded-lg p-5 no-underline text-gray-800 flex flex-col transition-all hover:border-emerald-500 hover:shadow-lg hover:-translate-y-1 cursor-pointer';

                const currentTicketInfo = station.currentTicket
                    ? `<span class="text-sm text-gray-800 font-semibold">#${station.currentTicket.id} - ${station.currentTicket.name}</span>`
                    : `<span class="text-sm text-gray-500 italic">Idle</span>`;

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-lg font-semibold text-gray-800">${station.name}</div>
                        <div class="bg-indigo-500 text-white px-3 py-1 rounded-full text-sm font-semibold group-hover:bg-emerald-500 transition-colors">#${station.id}</div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-xs text-gray-500 mb-1">Currently Serving:</div>
                        ${currentTicketInfo}
                    </div>
                    <div class="mt-5 p-3 bg-gray-100 rounded text-center text-sm">
                        <strong class="text-indigo-600">${data.queueRemaining}</strong> in queue
                    </div>
                `;

                container.appendChild(card);
            });

            document.getElementById('queueRemaining').textContent = data.queueRemaining;
        }

        // Load all stations (fallback when WS is unavailable)
        async function loadStations() {
            try {
                const response = await fetch('/station');
                const data = await response.json();

                if (data.success) {
                    renderStations(data);
                }
            } catch (error) {
                console.error('Failed to load stations:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            loadStations();
            initWebSocket();
        });
    </script>
</body>
