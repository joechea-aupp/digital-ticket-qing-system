<body class="min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-emerald-50 font-['Space_Grotesk'] text-slate-900">
    <div class="relative min-h-screen flex">
        {{> sidebar
            sidebarTitle="Stations"
            sidebarSubtitle="Manage counters"
            showQueue=true
            showDashboard=true
            showTopic=true
            showStations=true
            queueClass="text-slate-600 hover:bg-slate-100 font-medium text-sm transition"
            dashboardClass="text-slate-600 hover:bg-slate-100 font-medium text-sm transition"
            topicClass="text-slate-600 hover:bg-slate-100 font-medium text-sm transition"
            stationsClass="bg-emerald-100 text-emerald-700 font-medium text-sm transition"
        }}

        <!-- Main Content -->
        <div class="w-full md:ml-64 transition-all duration-300">
            {{> header-bar headerTitle="Manage Stations" showProfile=true }}

            <main class="relative mx-auto w-full max-w-6xl px-4 py-10 sm:px-6 lg:px-8">
                <div class="text-center">
                    <h1 class="text-3xl font-semibold tracking-tight">{{title}}</h1>
                    <p class="text-sm text-slate-500 mt-2">Click on a station to manage tickets</p>
                </div>

                <div id="stationsContainer" class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>

                <div id="queueInfo" class="mt-8 rounded-2xl bg-white/90 p-6 text-center shadow-lg ring-1 ring-slate-200/60">
                    <strong id="queueRemaining" class="text-2xl font-semibold text-emerald-600">0</strong>
                    <p class="mt-1 text-sm text-slate-500">tickets remaining in queue</p>
                </div>
            </main>
        </div>
    </div>

    {{> layout-scripts }}

    <script>
        let socket;

        // Initialize WebSocket
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(protocol + '//' + window.location.host + '/ws/stations');

            socket.onopen = () => {
                console.log('WebSocket connected');
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'stations') {
                    renderStations(data);
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            socket.onclose = () => {
                console.log('WebSocket disconnected, reconnecting in 3 seconds...');
                setTimeout(initWebSocket, 3000);
            };
        }

        function renderStations(data) {
            if (!data || !data.stations) {
                return;
            }

            const container = document.getElementById('stationsContainer');
            container.innerHTML = '';

            data.stations.forEach(station => {
                const card = document.createElement('a');
                card.href = `/station-view/${station.id}`;
                card.className = 'group bg-gray-50 border-2 border-gray-200 rounded-lg p-5 no-underline text-gray-800 flex flex-col transition-all hover:border-emerald-500 hover:shadow-lg hover:-translate-y-1 cursor-pointer';

                const currentTicketInfo = station.currentTicket
                    ? `<span class="text-sm text-gray-800 font-semibold">#${station.currentTicket.id} - ${station.currentTicket.name}</span>`
                    : station.isPaused
                        ? `<span class="text-sm text-amber-600 font-semibold">On break</span>`
                        : `<span class="text-sm text-gray-500 italic">Idle</span>`;

                const statusBadge = station.isPaused
                    ? '<span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-semibold">On break</span>'
                    : '<span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-semibold">Active</span>';

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <div class="text-lg font-semibold text-gray-800">${station.name}</div>
                            ${station.topicName ? `<div class="text-xs text-sky-600 font-semibold mt-1">${station.topicName}</div>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            ${statusBadge}
                            <div class="bg-indigo-500 text-white px-3 py-1 rounded-full text-sm font-semibold group-hover:bg-emerald-500 transition-colors">#${station.id}</div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-xs text-gray-500 mb-1">Currently Serving:</div>
                        ${currentTicketInfo}
                    </div>
                    <div class="mt-5 p-3 bg-gray-100 rounded text-center text-sm">
                        <strong class="text-indigo-600">${data.queueRemaining}</strong> in queue
                    </div>
                `;

                container.appendChild(card);
            });

            document.getElementById('queueRemaining').textContent = data.queueRemaining;
        }

        // Load all stations (fallback when WS is unavailable)
        async function loadStations() {
            try {
                const response = await fetch('/station');
                const data = await response.json();

                if (data.success) {
                    renderStations(data);
                }
            } catch (error) {
                console.error('Failed to load stations:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            loadStations();
            initWebSocket();
        });
    </script>
</body>
