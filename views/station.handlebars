<body class="min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-emerald-50 font-['Space_Grotesk'] text-slate-900">
    <div class="relative flex min-h-screen items-center justify-center px-4 py-8">
        <div class="pointer-events-none absolute inset-0">
            <div class="absolute -top-20 right-8 h-48 w-48 rounded-full bg-emerald-200/60 blur-3xl"></div>
            <div class="absolute -bottom-24 left-6 h-56 w-56 rounded-full bg-sky-200/70 blur-3xl"></div>
        </div>

        <main class="relative w-full max-w-2xl rounded-2xl bg-white/90 p-6 shadow-2xl ring-1 ring-slate-200/60 sm:p-10">
            <header class="text-center">
                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-500">Station Dashboard</p>
                <h1 class="mt-2 text-3xl font-semibold text-slate-900">{{station.name}}</h1>
                <p class="mt-2 text-sm text-slate-500">Station #{{station.id}}</p>
                <div id="stationStatus" class="mt-3 inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">Active</div>
            </header>

            <div id="message" class="mt-6 hidden rounded-lg border px-4 py-3 text-sm font-semibold"></div>

            <section class="mt-6 rounded-xl border border-emerald-100 bg-emerald-50 px-4 py-4 text-center">
                <p class="text-xs font-semibold uppercase tracking-wide text-emerald-700/80">Queue Remaining</p>
                <div class="mt-2 text-3xl font-semibold text-emerald-700" id="queueCount">0</div>
            </section>

            <section class="mt-6 space-y-4">
                <div class="station-current rounded-xl border border-slate-100 bg-slate-50 px-5 py-4 shadow-sm">
                    <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Currently Serving</h2>
                    {{#if station.currentTicket}}
                        <div class="mt-3 flex flex-col gap-4 sm:flex-row sm:items-center">
                            <div class="text-3xl font-semibold text-emerald-600">{{station.currentTicket.id}}</div>
                            <div class="flex-1">
                                <div class="text-lg font-semibold text-slate-900">{{station.currentTicket.name}}</div>
                                <div class="text-xs text-slate-500" id="currentTime">{{station.currentTicket.time}}</div>
                            </div>
                        </div>
                    {{else}}
                        <div class="mt-3 text-sm text-slate-500 italic">No customer being served</div>
                    {{/if}}
                </div>

                <div class="station-previous rounded-xl border border-slate-100 bg-white px-5 py-4 shadow-sm">
                    <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Last Served</h2>
                    {{#if station.previousTicket}}
                        <div class="mt-3 flex flex-col gap-4 sm:flex-row sm:items-center">
                            <div class="text-2xl font-semibold text-slate-500">{{station.previousTicket.id}}</div>
                            <div class="flex-1">
                                <div class="text-base font-semibold text-slate-800">{{station.previousTicket.name}}</div>
                                <div class="text-xs text-slate-500" id="previousTime">{{station.previousTicket.time}}</div>
                            </div>
                        </div>
                    {{else}}
                        <div class="mt-3 text-sm text-slate-500 italic">No previous customer</div>
                    {{/if}}
                </div>
            </section>

            <div class="mt-8 flex flex-col gap-3 sm:flex-row">
                <button class="flex-1 rounded-lg bg-emerald-600 px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-700" onclick="nextTicket()">Next Ticket</button>
                <button class="flex-1 rounded-lg bg-rose-600 px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-rose-700" onclick="clearCurrent()">Clear Current</button>
                <button class="flex-1 rounded-lg border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-600 shadow-sm transition hover:bg-slate-50" onclick="location.href='/stations'">Back to Stations</button>
            </div>
        </main>
    </div>

    <script>
        const stationId = {{stationId}};
        let socket;

        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(protocol + '//' + window.location.host);

            socket.onopen = () => {
                console.log('WebSocket connected');
                refreshStation();
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'state' || data.type === 'update') {
                    refreshStation();
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            socket.onclose = () => {
                console.log('WebSocket disconnected, reconnecting in 3 seconds...');
                setTimeout(initWebSocket, 3000);
            };
        }

        async function refreshStation() {
            try {
                const response = await fetch(`/station/${stationId}`);
                const data = await response.json();

                if (data.success) {
                    const station = data.station;
                    const statusEl = document.getElementById('stationStatus');
                    if (statusEl) {
                        if (station.isPaused) {
                            statusEl.textContent = 'On break';
                            statusEl.className = 'mt-3 inline-flex items-center rounded-full bg-amber-100 px-3 py-1 text-xs font-semibold text-amber-700';
                        } else {
                            statusEl.textContent = 'Active';
                            statusEl.className = 'mt-3 inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700';
                        }
                    }

                    const currentSection = document.querySelector('.station-current');
                    if (station.currentTicket) {
                        currentSection.innerHTML = `
                            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Currently Serving</h2>
                            <div class="mt-3 flex flex-col gap-4 sm:flex-row sm:items-center">
                                <div class="text-3xl font-semibold text-emerald-600">${station.currentTicket.id}</div>
                                <div class="flex-1">
                                    <div class="text-lg font-semibold text-slate-900">${station.currentTicket.name}</div>
                                    <div class="text-xs text-slate-500">${new Date(station.currentTicket.time).toLocaleTimeString()}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        currentSection.innerHTML = `
                            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Currently Serving</h2>
                            <div class="mt-3 text-sm text-slate-500 italic">No customer being served</div>
                        `;
                    }

                    const previousSection = document.querySelector('.station-previous');
                    if (station.previousTicket) {
                        previousSection.innerHTML = `
                            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Last Served</h2>
                            <div class="mt-3 flex flex-col gap-4 sm:flex-row sm:items-center">
                                <div class="text-2xl font-semibold text-slate-500">${station.previousTicket.id}</div>
                                <div class="flex-1">
                                    <div class="text-base font-semibold text-slate-800">${station.previousTicket.name}</div>
                                    <div class="text-xs text-slate-500">${new Date(station.previousTicket.time).toLocaleTimeString()}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        previousSection.innerHTML = `
                            <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Last Served</h2>
                            <div class="mt-3 text-sm text-slate-500 italic">No previous customer</div>
                        `;
                    }

                    document.getElementById('queueCount').textContent = data.queueRemaining;
                }
            } catch (error) {
                console.error('Failed to refresh station:', error);
            }
        }

        async function nextTicket() {
            try {
                const response = await fetch(`/station/${stationId}/next-ticket`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Advanced to next ticket', 'success');
                    refreshStation();
                } else {
                    showMessage(data.error || 'Failed to advance to next ticket', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function clearCurrent() {
            try {
                const response = await fetch(`/station/${stationId}/clear-current`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Current ticket cleared', 'success');
                    refreshStation();
                } else {
                    showMessage(data.error || 'Failed to clear current ticket', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'mt-6 rounded-lg border px-4 py-3 text-sm font-semibold';

            if (type === 'success') {
                messageDiv.classList.add('border-emerald-200', 'bg-emerald-50', 'text-emerald-700');
            } else {
                messageDiv.classList.add('border-rose-200', 'bg-rose-50', 'text-rose-700');
            }

            messageDiv.classList.remove('hidden');

            setTimeout(() => {
                messageDiv.className = 'mt-6 hidden rounded-lg border px-4 py-3 text-sm font-semibold';
                messageDiv.textContent = '';
            }, 4000);
        }

        window.addEventListener('load', () => {
            initWebSocket();
        });

        setInterval(refreshStation, 5000);
    </script>
</body>
