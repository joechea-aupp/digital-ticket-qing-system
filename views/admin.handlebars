<body class="min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-emerald-50 font-['Space_Grotesk'] text-slate-900">
    <div class="relative min-h-screen flex">
        {{> sidebar
            sidebarTitle="Admin"
            sidebarSubtitle="Manage your queue"
            showQueue=true
            showDashboard=true
            showTopic=true
            showStations=true
            queueClass="bg-emerald-100 text-emerald-700 font-medium text-sm transition"
            dashboardClass="text-slate-600 hover:bg-slate-100 font-medium text-sm transition"
                        topicClass="text-slate-600 hover:bg-slate-100 font-medium text-sm transition"
            stationsClass="text-slate-600 hover:bg-slate-100 font-medium text-sm transition"
        }}

        <!-- Main Content -->
        <div class="w-full md:ml-64 transition-all duration-300">
            {{> header-bar headerTitle="Queue Management" showProfile=true }}

            <div class="pointer-events-none absolute inset-0">
                <div class="absolute -top-20 right-4 h-48 w-48 rounded-full bg-emerald-200/60 blur-3xl"></div>
                <div class="absolute -bottom-24 left-4 h-56 w-56 rounded-full bg-sky-200/70 blur-3xl"></div>
            </div>
            <main class="relative mx-auto w-full px-4 py-8 sm:px-6 lg:px-8">
                <header class="text-center">
                    <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl">Queue Management</h1>
                    <div class="mt-4 inline-flex items-center gap-2 rounded-full bg-white/80 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm ring-1 ring-slate-200/70">
                        <span id="statusIndicator" class="inline-block h-2 w-2 rounded-full bg-rose-500"></span>
                        <span id="statusText">Connecting...</span>
                    </div>
                </header>

                <div class="mt-8 space-y-4">
                    <div id="errorAlert" class="hidden rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700 shadow-sm" role="alert"></div>
                    <div id="successAlert" class="hidden rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700 shadow-sm" role="alert"></div>
                </div>

                <div class="mt-6 flex flex-col items-center gap-4 sm:flex-row sm:justify-between">
                    <button class="inline-flex w-full items-center justify-center rounded-lg bg-emerald-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-700 sm:w-auto" onclick="openModal()">
                        + Add Agent/Counter
                    </button>
                    <p class="text-sm text-slate-500">Manage counters and live queue updates.</p>
                </div>

                <section class="mt-6 rounded-2xl bg-white/90 p-6 shadow-lg ring-1 ring-slate-200/60">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-slate-900">Active Counters</h2>
                        <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">Live</span>
                    </div>
                    <div id="agentsTableContainer" class="mt-4">
                        <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-6 py-8 text-center text-sm text-slate-500">
                            No agents added yet. Click "Add Agent/Counter" to get started.
                        </div>
                    </div>
                </section>

                <a href="/ticket-queue" class="mt-4 mb-4 inline-flex w-full items-center justify-center gap-2 rounded-lg border-2 border-sky-200 bg-sky-50 px-4 py-2.5 text-sm font-semibold text-sky-700 shadow-sm transition hover:bg-sky-100 hover:border-sky-300">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    View Ticket Queue Display
                </a>

                <section class="mt-6 rounded-2xl bg-white/90 p-6 shadow-lg ring-1 ring-slate-200/60">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-slate-900">Queue</h2>
                            <button onclick="forceExpireAllTickets()" class="mt-2 inline-flex items-center gap-2 rounded-lg bg-rose-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-rose-700">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Force Expire All Tickets
                            </button>
                        </div>
                        <div class="rounded-lg bg-slate-50 px-4 py-2 text-center">
                            <div class="text-2xl font-semibold text-emerald-600" id="queueRemaining">0</div>
                            <div class="text-xs uppercase tracking-wide text-slate-500">In Queue</div>
                        </div>
                    </div>
                    <div id="queueList" class="mt-4 space-y-3">
                        <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-6 py-8 text-center text-sm text-slate-500">
                            Waiting for connection...
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="addAgentModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40 p-4" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="relative w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-900">Add Agent/Counter</h2>
                <button class="rounded-full p-1 text-slate-400 transition hover:text-slate-600" onclick="closeModal()" aria-label="Close modal">
                    &times;
                </button>
            </div>
            <div class="mt-5">
                <label for="agentName" class="text-sm font-semibold text-slate-600">Counter Name</label>
                <input type="text" id="agentName" placeholder="e.g., Counter 1, Window A" class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-800 placeholder:text-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200" />
            </div>
            <div class="mt-5">
                <label for="agentTopic" class="text-sm font-semibold text-slate-600">Associated Topic</label>
                <select id="agentTopic" class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-800 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200">
                    <option value="">-- Select a topic --</option>
                    {{#each topics}}
                    <option value="{{this.id}}">{{this.name}} ({{this.prefix_id}})</option>
                    {{/each}}
                </select>
            </div>
            <div class="mt-6 flex items-center justify-end gap-3">
                <button class="rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-50" onclick="closeModal()">Cancel</button>
                <button class="rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-700" onclick="addAgent()">Add Counter</button>
            </div>
        </div>
    </div>

    {{> layout-scripts }}

    <div id="actionMenuContainer" class="fixed inset-0 pointer-events-none z-50"></div>

    <script>
        let ws = null;
        let queue = [];
        let agents = [];

        const connectedClasses = ["bg-emerald-500", "animate-pulse"];
        const disconnectedClasses = ["bg-rose-500"];
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/admin`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateStatus(true);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.queue !== undefined) {
                        queue = data.queue;
                        agents = data.agents || [];
                        updateDisplay();
                    } else if (data.error) {
                        showError(data.error);
                    } else if (data.success) {
                        if (data.message) {
                            showSuccess(data.message);
                        }
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus(false);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateStatus(false);
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updateStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            indicator.classList.remove(...connectedClasses, ...disconnectedClasses);
            if (connected) {
                indicator.classList.add(...connectedClasses);
                text.textContent = 'Connected';
            } else {
                indicator.classList.add(...disconnectedClasses);
                text.textContent = 'Disconnected';
            }
        }

        function updateDisplay() {
            document.getElementById('queueRemaining').textContent = queue.length;

            const agentsTableEl = document.getElementById('agentsTableContainer');
            if (agents.length === 0) {
                agentsTableEl.innerHTML = `
                    <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-6 py-8 text-center text-sm text-slate-500">
                        No agents added yet. Click "Add Agent/Counter" to get started.
                    </div>
                `;
            } else {
                agentsTableEl.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 text-sm">
                            <thead class="bg-slate-900 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Topic</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Serving</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Customer</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${agents.map(agent => `
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-4 py-3 font-semibold text-slate-800">${agent.name}</td>
                                        <td class="px-4 py-3">
                                            ${agent.topicId ? `<span class="text-xs font-semibold text-sky-600 bg-sky-50 px-2 py-1 rounded">${agent.topicName || 'Topic ' + agent.topicId}</span>` : '<span class="text-slate-400 italic">No topic</span>'}
                                        </td>
                                        <td class="px-4 py-3">
                                            ${agent.currentTicket ? `
                                                <span class="inline-flex items-center rounded-md bg-slate-900 px-2 py-0.5 text-xs font-semibold text-white">${agent.currentTicket.id}</span>
                                            ` : `
                                                <span class="text-slate-400 italic">No ticket</span>
                                            `}
                                        </td>
                                        <td class="px-4 py-3 text-slate-700">${agent.currentTicket ? agent.currentTicket.name : '-'}</td>
                                        <td class="px-4 py-3">
                                            ${agent.isPaused ? `
                                                <span class="inline-flex items-center rounded-full bg-amber-100 px-3 py-1 text-xs font-semibold text-amber-700">On break</span>
                                            ` : `
                                                <span class="inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">Active</span>
                                            `}
                                        </td>
                                        <td class="px-4 py-3">
                                            <button class="action-btn rounded-md bg-slate-700 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-slate-800" data-agent-id="${agent.id}" data-queue-length="${queue.length}" data-has-ticket="${agent.currentTicket ? 'true' : 'false'}" data-is-paused="${agent.isPaused ? 'true' : 'false'}">
                                                Actions
                                                <span class="ml-1.5 inline-block text-xs">‚ñº</span>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            const queueListEl = document.getElementById('queueList');
            if (queue.length === 0) {
                queueListEl.innerHTML = `
                    <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-6 py-8 text-center text-sm text-slate-500">
                        No tickets in queue
                    </div>
                `;
            } else {
                queueListEl.innerHTML = queue.map((ticket) => `
                    <div class="flex items-start justify-between rounded-xl border border-slate-100 bg-white px-4 py-3 shadow-sm">
                        <div>
                            <div class="text-sm font-semibold text-emerald-600">Ticket ${ticket.id}</div>
                            <div class="text-base font-medium text-slate-800">${ticket.name}</div>
                            <div class="text-xs text-slate-400">${new Date(ticket.time).toLocaleString()}</div>
                        </div>
                    </div>
                `).join('');
            }

            // Attach event handlers to action buttons
            attachActionButtonHandlers();
        }

        function openModal() {
            const modal = document.getElementById('addAgentModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.setAttribute('aria-hidden', 'false');
            document.getElementById('agentName').focus();
        }

        function closeModal() {
            const modal = document.getElementById('addAgentModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modal.setAttribute('aria-hidden', 'true');
            document.getElementById('agentName').value = '';
            document.getElementById('agentTopic').value = '';
        }

        function addAgent() {
            const agentNameInput = document.getElementById('agentName');
            const agentTopicInput = document.getElementById('agentTopic');
            const agentName = agentNameInput.value.trim();
            const topicId = agentTopicInput.value.trim();

            if (!agentName) {
                showError('Please enter a counter name');
                return;
            }

            if (!topicId) {
                showError('Please select an associated topic');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('Not connected to server');
                return;
            }

            // Get the topic name from the selected option
            const selectedOption = agentTopicInput.options[agentTopicInput.selectedIndex];
            const topicName = selectedOption.text.split(' (')[0]; // Extract name before the prefix

            ws.send(JSON.stringify({
                action: 'addAgent',
                agentName: agentName,
                topicId: parseInt(topicId),
                topicName: topicName
            }));

            agentNameInput.value = '';
            agentTopicInput.value = '';
            closeModal();
        }

        function toggleActionMenu(button, event) {
            event.stopPropagation();
            
            // Close any existing menus
            closeAllMenus();
            
            if (event.type === 'click') {
                const agentId = button.dataset.agentId;
                const queueLength = parseInt(button.dataset.queueLength);
                const hasTicket = button.dataset.hasTicket === 'true';
                const isPaused = button.dataset.isPaused === 'true';
                
                const rect = button.getBoundingClientRect();
                const menuContainer = document.getElementById('actionMenuContainer');
                
                const menu = document.createElement('div');
                menu.className = 'action-menu fixed rounded-lg border border-slate-200 bg-white shadow-lg ring-1 ring-slate-100 w-40 pointer-events-auto';
                menu.style.top = (rect.bottom + 8) + 'px';
                menu.style.right = (window.innerWidth - rect.right) + 'px';
                
                menu.innerHTML = `
                    <button class="w-full px-4 py-2.5 text-left text-xs font-semibold text-emerald-600 transition hover:bg-emerald-50 disabled:text-slate-300 disabled:hover:bg-white ${queueLength === 0 ? 'opacity-50 cursor-not-allowed' : ''}" onclick="nextTicket(${agentId}); closeAllMenus()" ${queueLength === 0 ? 'disabled' : ''}>
                        ‚úì Next Ticket
                    </button>
                    <button class="w-full px-4 py-2.5 text-left text-xs font-semibold text-sky-600 transition hover:bg-sky-50" onclick="togglePause(${agentId}, ${!isPaused}); closeAllMenus()">
                        ‚è∏ ${isPaused ? 'Resume' : 'Pause'}
                    </button>
                    <button class="w-full px-4 py-2.5 text-left text-xs font-semibold text-amber-600 transition hover:bg-amber-50 disabled:text-slate-300 disabled:hover:bg-white ${!hasTicket ? 'opacity-50 cursor-not-allowed' : ''}" onclick="clearCurrent(${agentId}); closeAllMenus()" ${!hasTicket ? 'disabled' : ''}>
                        ‚úï Clear Current
                    </button>
                    <div class="border-t border-slate-100"></div>
                    <button class="w-full px-4 py-2.5 text-left text-xs font-semibold text-rose-600 transition hover:bg-rose-50" onclick="removeAgent(${agentId}); closeAllMenus()">
                        üóë Remove
                    </button>
                `;
                
                menuContainer.appendChild(menu);
                menuContainer.classList.remove('pointer-events-none');
            }
        }

        function closeAllMenus() {
            const menuContainer = document.getElementById('actionMenuContainer');
            menuContainer.innerHTML = '';
            menuContainer.classList.add('pointer-events-none');
        }

        document.addEventListener('click', closeAllMenus);

        // Attach click handlers to action buttons when table updates
        function attachActionButtonHandlers() {
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', (e) => toggleActionMenu(btn, e));
            });
        }

        function togglePause(agentId, isPaused) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('Not connected to server');
                return;
            }

            ws.send(JSON.stringify({
                action: 'togglePause',
                agentId,
                isPaused
            }));
        }

        function removeAgent(agentId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('Not connected to server');
                return;
            }

            if (confirm('Are you sure you want to remove this counter? Any current ticket will be returned to the queue.')) {
                ws.send(JSON.stringify({
                    action: 'removeAgent',
                    agentId: agentId
                }));
            }
        }

        function nextTicket(agentId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('Not connected to server');
                return;
            }

            if (queue.length === 0) {
                showError('No tickets in queue');
                return;
            }

            ws.send(JSON.stringify({
                action: 'nextTicket',
                agentId: agentId
            }));
        }

        function clearCurrent(agentId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showError('Not connected to server');
                return;
            }

            ws.send(JSON.stringify({
                action: 'clearCurrent',
                agentId: agentId
            }));
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 3000);
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 3000);
        }

        async function forceExpireAllTickets() {
            if (!confirm('Are you sure you want to force expire ALL tickets and clear the queue? This will invalidate all existing tickets held by customers and remove all pending tickets from the queue.')) {
                return;
            }

            try {
                const response = await fetch('/api/force-expire-tickets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccess(data.message || 'All tickets have been force expired and queue cleared');
                } else {
                    showError(data.error || 'Failed to force expire tickets');
                }
            } catch (error) {
                console.error('Error force expiring tickets:', error);
                showError('Failed to force expire tickets');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('agentName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addAgent();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            document.getElementById('addAgentModal').addEventListener('click', (e) => {
                if (e.target.id === 'addAgentModal') {
                    closeModal();
                }
            });
        });

        window.addEventListener('load', connectWebSocket);

        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
        });
    </script>
</body>
